<div
  class="min-h-screen bg-ozark-900 text-white p-10 flex flex-col items-center justify-start font-sans"
>
  <div class="flex items-center space-x-4 mb-8 mt-10">
    <h1 class="text-4xl font-bold text-ozark-accent tracking-widest">√òZARK</h1>

    <button
      *ngIf="!isSignedInToPuter"
      (click)="connectToPuter()"
      class="text-xs border border-ozark-accent text-ozark-accent px-3 py-1 rounded hover:bg-ozark-accent hover:text-black transition-colors"
    >
      ‚ö° Connect AI
    </button>
    <span
      *ngIf="isSignedInToPuter"
      class="text-xs text-green-400 font-mono border border-green-900 bg-green-900/20 px-2 py-1 rounded"
    >
      ‚óè AI Online
    </span>
  </div>

  <div
    class="bg-ozark-800 p-8 rounded-xl shadow-2xl border border-ozark-700 w-full max-w-md text-center transition-all hover:border-ozark-accent/50"
  >
    <p class="text-gray-400 mb-6 font-light">
      Upload Bank or CC Statement (CSV)
    </p>
    <label class="block cursor-pointer group">
      <span class="sr-only">Choose file</span>
      <input
        type="file"
        (change)="onFileSelected($event)"
        class="block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-ozark-accent file:text-ozark-900 hover:file:bg-cyan-300 transition-colors cursor-pointer"
      />
    </label>
  </div>

  <div
    *ngIf="isCategorizing"
    class="mt-8 flex flex-col items-center space-y-2 text-ozark-accent animate-pulse"
  >
    <div class="flex items-center space-x-2">
      <svg class="w-6 h-6 spin-slow" fill="none" viewBox="0 0 24 24">
        <path
          stroke="currentColor"
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M12 6v6m0 0v6m0-6h6m-6 0H6"
        />
      </svg>
      <span class="text-lg font-mono">Analyzing Transactions...</span>
    </div>
    <p class="text-xs text-gray-500">
      Consulting Knowledge Base & Identifying Merchants
    </p>
  </div>

  <div
    *ngIf="fileName && transactions.length > 0"
    class="mt-10 w-full max-w-6xl animate-fade-in-up"
  >
    <div
      class="bg-ozark-800 rounded-xl border border-ozark-700 overflow-visible shadow-2xl"
    >
      <div
        class="bg-ozark-700/50 px-6 py-4 flex justify-between items-center border-b border-ozark-700"
      >
        <div>
          <span class="font-bold text-white text-lg tracking-wide">{{
            fileName
          }}</span>
          <p class="text-xs text-gray-400 mt-1">Smart categorization enabled</p>
        </div>
        <span
          class="bg-ozark-900 px-3 py-1 rounded-full text-xs font-mono text-ozark-accent border border-ozark-accent/30"
        >
          {{ transactions.length }} ITEMS
        </span>
      </div>

      <div class="overflow-visible pb-20">
        <table class="w-full text-left text-sm text-gray-400">
          <thead
            class="bg-ozark-900 text-gray-500 uppercase font-bold text-xs tracking-wider border-b border-ozark-700"
          >
            <tr>
              <th class="px-6 py-4">Date</th>
              <th class="px-6 py-4">Description</th>
              <th class="px-6 py-4">Smart Category</th>
              <th class="px-6 py-4 text-right">Amount</th>
            </tr>
          </thead>

          <tbody class="divide-y divide-ozark-700">
            <tr
              *ngFor="let t of transactions; let i = index"
              class="hover:bg-ozark-700/30 transition-colors group relative"
            >
              <td class="px-6 py-4 font-mono text-gray-500 whitespace-nowrap">
                {{ t.date }}
              </td>

              <td class="px-6 py-4 text-white font-medium text-base">
                {{ t.description }}

                <div
                  *ngIf="t.userNote"
                  class="text-xs text-ozark-accent mt-1 italic flex items-center gap-1"
                >
                  <span>‚ÑπÔ∏è</span> {{ t.userNote }}
                </div>

                <div
                  *ngIf="t.aiReasoning && !t.userNote"
                  class="text-[10px] text-gray-500 mt-1 flex items-center gap-1"
                >
                  <span>ü§ñ</span> {{ t.aiReasoning }}
                </div>
              </td>

              <td class="px-6 py-4 relative">
                <button
                  (click)="openSmartEdit(i)"
                  [class]="getBadgeClass(t)"
                  class="px-3 py-1 rounded-full text-xs font-bold border opacity-90 hover:opacity-100 transition-all hover:scale-105 flex items-center gap-2"
                >
                  {{ t.category || "Uncategorized" }}

                  <span
                    *ngIf="t.userNote"
                    class="text-[10px]"
                    title="Has Memory"
                    >‚òÖ</span
                  >

                  <svg
                    class="w-3 h-3 opacity-50 group-hover:opacity-100"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"
                    ></path>
                  </svg>
                </button>

                <div
                  *ngIf="selectedTxnIndex === i"
                  class="absolute z-50 left-0 top-12 w-80 bg-gray-900 border border-gray-600 rounded-lg shadow-2xl p-4 animate-fade-in origin-top-left ring-1 ring-ozark-accent/20"
                >
                  <div class="mb-4 border-b border-gray-700 pb-3">
                    <div class="flex justify-between items-start">
                      <p
                        class="text-[10px] text-ozark-accent font-bold uppercase tracking-wider"
                      >
                        Edit & Teach
                      </p>
                      <button
                        (click)="openSmartEdit(i)"
                        class="text-gray-400 hover:text-white"
                      >
                        ‚úï
                      </button>
                    </div>
                    <p
                      class="text-xs text-gray-500 mt-1 break-all bg-black/30 p-1 rounded font-mono"
                      title="Original Bank Text"
                    >
                      {{ t.originalRaw | slice : 0 : 40 }}...
                    </p>
                    <button
                      (click)="restoreOriginal(t)"
                      class="text-[10px] text-blue-400 hover:underline mt-1"
                    >
                      ‚Ü∫ Reset Name
                    </button>
                  </div>

                  <div class="space-y-3">
                    <div>
                      <label
                        class="text-[10px] text-gray-400 uppercase block mb-1"
                        >Rename:</label
                      >
                      <input
                        [(ngModel)]="editForm.cleanName"
                        class="w-full bg-black border border-gray-700 rounded px-2 py-1.5 text-xs text-white focus:border-ozark-accent outline-none"
                      />
                    </div>

                    <div>
                      <label
                        class="text-[10px] text-gray-400 uppercase block mb-1"
                        >Category:</label
                      >
                      <select
                        [(ngModel)]="editForm.category"
                        class="w-full bg-black border border-gray-700 rounded px-2 py-1.5 text-xs text-white focus:border-ozark-accent outline-none"
                      >
                        <option *ngFor="let cat of categories" [value]="cat">
                          {{ cat }}
                        </option>
                      </select>
                    </div>

                    <div>
                      <label
                        class="text-[10px] text-gray-400 uppercase block mb-1"
                        >Memory Note (Context):</label
                      >
                      <textarea
                        [(ngModel)]="editForm.note"
                        placeholder="e.g. 'Transfers from Arjun are usually Rent share'"
                        rows="2"
                        class="w-full bg-black border border-gray-700 rounded px-2 py-1.5 text-xs text-white focus:border-ozark-accent outline-none resize-none"
                      ></textarea>
                    </div>
                  </div>

                  <button
                    (click)="saveMemory(t)"
                    class="w-full mt-4 bg-ozark-accent text-black text-xs font-bold py-2 rounded hover:bg-cyan-400 transition-colors shadow-lg shadow-ozark-accent/20"
                  >
                    üíæ Save Memory
                  </button>
                </div>
              </td>

              <td class="px-6 py-4 text-right font-mono text-base font-bold">
                <span
                  [ngClass]="{
                    'text-green-400': t.type === 'CREDIT',
                    'text-red-400': t.type === 'DEBIT'
                  }"
                >
                  {{ t.type === "DEBIT" ? "-" : "+" }} ‚Çπ{{
                    t.amount | number : "1.0-0"
                  }}
                </span>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
